<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M21 17H3V5H21V17M21 3H3C1.9 3 1 3.9 1 5V17C1 18.1 1.9 19 3 19H21C22.1 19 23 18.1 23 17V5C23 3.9 22.1 3 21 3M12 16H14V14H16V12H14V10H12V12H10V14H12V16M7 11.5C7 12.3 6.3 13 5.5 13S4 12.3 4 11.5 4.7 10 5.5 10S7 10.7 7 11.5M19 11.5C19 12.3 18.3 13 17.5 13S16 12.3 16 11.5 16.7 10 17.5 10S19 10.7 19 11.5Z' fill='gray'/%3E%3C/svg%3E">
    <title>數據中心</title>
    <!-- 添加Font Awesome圖標 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 添加Chart.js庫 - 使用多個來源確保加載 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" 
            onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';">
    </script>
    <script>
        // 檢查Chart.js是否已加載，如果沒有則嘗試其他來源
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof Chart === 'undefined') {
                    console.log('從CDN加載Chart.js失敗，嘗試其他來源...');
                    var script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                    document.head.appendChild(script);
                    
                    script.onload = function() {
                        console.log('成功從備用來源加載Chart.js');
                        if (window.chartLoadedCallback) {
                            window.chartLoadedCallback();
                        }
                    };
                } else {
                    console.log('Chart.js已成功加載');
                    if (window.chartLoadedCallback) {
                        window.chartLoadedCallback();
                    }
                }
            }, 500);
        });
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="region-styles.css">
    <link rel="stylesheet" href="action-buttons.css">
</head>
<body>
    <h1>SWSAD數據中心</h1>
    
    <div class="container">
        <div class="input-section">
            <h2>輸入區域</h2>
            
            <!-- 功能區塊：分為「手動觸發腳本」與「手動匯入文件」兩個簡約區塊 -->
            <style>
                .feature-block { border: 1px solid #ddd; padding: 10px; margin-bottom: 12px; border-radius: 0 !important; }
                .feature-block h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--text-secondary); }
                .tile-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
                .tile { background:#111; color:#fff; border:1px solid #333; display:flex; align-items:center; justify-content:center; flex-direction:column; cursor:pointer; border-radius:0 !important; aspect-ratio: 1 / 1; min-height:84px; box-sizing:border-box; padding:8px; }
                .tile small { color:#ccc; font-size:12px; }
                .tile.dragover { border-color: #4CAF50; box-shadow: none; }
                button.tile { appearance: none; -webkit-appearance: none; border-radius: 0 !important; padding: 0; margin: 0; }
                /* force no rounded corners inside tiles */
                .tile, .tile * { border-radius: 0 !important; }
            </style>

            <div class="feature-block" id="block-scripts">
                <h4>手動觸發腳本</h4>
                <div class="tile-grid">
                    <button id="autoUpdateButton" class="tile">庫存<br><small>scraper.py</small></button>
                    <button id="autoUpdateSalesButton" class="tile">銷售額<br><small>salesscraper.py</small></button>
                </div>
            </div>

            <div class="feature-block" id="block-imports">
                <h4>手動匯入文件</h4>
                <div class="tile-grid">
                    <!-- 倉庫：點擊或拖放 Excel 檔案 -->
                    <div id="warehouseDropzone" class="tile" title="點擊或拖放倉庫檔案 (.xlsx/.xls)">
                        <input type="file" id="warehouseFile" accept=".xlsx,.xls" style="display:none">
                        <div>倉庫</div>
                        <small id="warehouseFileName" style="display:block; color:#ccc; font-size:12px;">Remain Stock</small>
                    </div>

                    <!-- 庫存：上傳 JSON 庫存文件 -->
                    <div id="inventoryDropzone" class="tile" title="點擊或拖放庫存 JSON 檔案">
                        <input type="file" id="inventoryFileInput" accept=".json" style="display:none">
                        <div>庫存</div>
                        <small>JSON</small>
                    </div>

                    <!-- 銷售訂單：匯入 Excel 銷售檔案 -->
                    <div id="salesDropzone" class="tile" title="點擊或拖放銷售 Excel 檔案 (.xlsx/.xls)">
                        <input type="file" id="salesFileInput" accept=".xlsx, .xls" style="display:none">
                        <div>銷售訂單</div>
                        <small>Device Sale Detail</small>
                    </div>

                    <!-- 留一格給後續功能，例如展示階段啟動 -->
                    <button id="openChartWindowButton" class="tile">展示階段<br><small>/presentation</small></button>
                </div>
            </div>

            <div id="debugInfo" style="display:none; margin-top: 10px; padding: 10px; background-color: #f8f8f8; border: 1px solid #ddd; max-height: 200px; overflow: auto; font-family: monospace; font-size: 12px;"></div>
            
            <div class="update-log-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px; font-weight: 500; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">最近更新紀錄</h3>
                <div id="updateLogList" style="max-height: 200px; overflow-y: auto; font-size: 12px; line-height: 1.6;">
                    <!-- Log entries will be inserted here by script.js -->
                </div>
            </div>
        
            <!-- 側邊舊有使用者管理已移除，改以右側用戶管理 (userManagement) 為主 -->
        </div>
        
        <div class="output-section">
            <h2>結果顯示</h2>
            <div class="controls-header">
                <div class="sort-controls">
                    <button id="sortByName" data-sort-key="store">機台名稱<span class="sort-icon"></span></button>
                    <button id="sortById" data-sort-key="machineId">機台編號<span class="sort-icon"></span></button>
                    <button id="sortByInventory" data-sort-key="totalQuantity">庫存總量<span class="sort-icon"></span></button>
                    <button id="sortByTime" data-sort-key="processTime">更新時間<span class="sort-icon"></span></button>
                </div>
                <div class="right-side-controls">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜尋機台...">
                    <button id="viewAsCardButton" class="view-icon-btn active" title="卡片視圖"><i class="fas fa-th-large"></i></button>
                    <button id="viewAsListButton" class="view-icon-btn" title="列表視圖"><i class="fas fa-bars"></i></button>
                </div>
            </div>
            <div id="outputTable"></div>
            <div id="outputList" style="display: none;"></div>
            <!-- User management tab -->
            <div id="userManagement" style="margin-top:20px; display:none; position:relative;">
                <!-- h2 will display the active page title; per-user heading removed to avoid duplicate titles -->
                <div id="usersListContainerWrapper" style="position:relative;">
                    <div id="usersListContainer" style="max-height:400px; overflow:auto; border:1px solid #ddd; padding:8px; background:#111;"></div>
                </div>
                <div id="createUserPanel" style="display:none; margin-top:8px; padding:8px; border:1px solid #444; background:#111; color:#eee;">
                    <h4>新增用戶</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <input id="cu_username" placeholder="username" style="background:#000; color:#fff; border:1px solid #333; padding:6px;" />
                        <input id="cu_password" placeholder="password" type="password" style="background:#000; color:#fff; border:1px solid #333; padding:6px;" />
                        <input id="cu_displayName" placeholder="顯示名稱" style="background:#000; color:#fff; border:1px solid #333; padding:6px;" />
                        <input id="cu_email" placeholder="email" style="background:#000; color:#fff; border:1px solid #333; padding:6px;" />
                    </div>
                    <div style="margin-top:8px;"><label style="color:#ddd;">指派機台 (多選 Ctrl/Cmd)</label><select id="cu_assignStores" multiple style="width:100%; min-height:120px; background:#000; color:#fff; border:1px solid #333;"></select></div>
                    <div style="margin-top:8px;"><button id="cu_createBtn" class="btn-primary">建立</button> <button id="cu_cancelBtn" class="btn-clear">取消</button> <span id="cu_status" style="color:#ccc;"></span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 備註與地址編輯對話框 -->
    <div id="editDialog" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>編輯備註和地址</h2>
            <div class="form-group">
                <label for="storeAddress">店鋪地址：</label>
                <input type="text" id="storeAddress" placeholder="輸入店鋪地址">
            </div>
            <div class="form-group">
                <label for="storeSales">上月銷售額：</label>
                <input type="number" id="storeSales" placeholder="輸入銷售金額" min="0" step="1">
            </div>
            <div class="form-group">
                <label for="storeNote">備註：</label>
                <textarea id="storeNote" placeholder="輸入備註信息..."></textarea>
            </div>
            <button id="saveNoteButton" class="btn-primary">保存</button>
        </div>
    </div>
    
    <!-- 月份選擇對話框 -->
    <div id="monthSelectionDialog" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>選擇銷售數據月份</h2>
            <div class="form-group">
                <label for="monthSelect">請選擇要分析的月份：</label>
                <select id="monthSelect" class="form-control"></select>
            </div>
            <button id="confirmMonthButton" class="btn-primary">確認</button>
            <button id="cancelMonthButton" class="btn-clear">取消</button>
        </div>
    </div>
    
    <!-- 管理使用者可見機台的對話框 -->
            <div id="manageStoresModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>管理使用者可見機台</h2>
            <p>請從下方選擇機台（可多選，按住 Ctrl / Cmd 進行多選）</p>
            <div class="form-group">
                <select id="manageStoresSelect" multiple style="width:100%; min-height:200px; background:#000; color:#fff; border:1px solid #333;"></select>
            </div>
            <div style="margin-top:8px; display:flex; gap:8px;">
                <button id="manageStoresSaveBtn" class="btn-primary">儲存</button>
                <button id="manageStoresCancelBtn" class="btn-clear">取消</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html> 