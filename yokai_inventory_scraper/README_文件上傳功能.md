# 庫存文件上傳功能使用說明

## 功能概述

為了減少伺服器 CPU 負載，避免在伺服器上運行爬蟲腳本，我們新增了庫存文件上傳功能。您可以在本地運行爬蟲，生成 JSON 文件，然後上傳到伺服器。

## 使用流程

### 1. 本地運行爬蟲

#### 方法一：使用本地爬蟲腳本（推薦）

1. **運行本地爬蟲腳本**：
   ```bash
   python local_scraper.py
   ```

2. **腳本會自動**：
   - 運行爬蟲獲取庫存數據
   - 解析並格式化數據
   - 生成 JSON 文件（格式：`inventory_upload_YYYYMMDD_HHMMSS.json`）
   - 顯示統計信息和上傳說明

#### 方法二：手動運行原始爬蟲

1. **運行原始爬蟲**：
   ```bash
   python scraper.py
   ```

2. **使用生成的 JSON 文件**：
   - 腳本會生成 `structured_inventory.json` 文件
   - 可以直接使用此文件進行上傳

### 2. 上傳文件到伺服器

#### 方法一：使用網頁界面（推薦）

1. 打開數據中心網頁
2. 點擊「上傳庫存文件」按鈕
3. 選擇生成的 JSON 文件
4. 等待上傳完成
5. 系統會自動刷新數據並顯示結果

#### 方法二：使用 curl 命令

```bash
curl -X POST -F "file=@inventory_upload_20250101_120000.json" http://your-server-url/upload-inventory-file
```

## 文件格式要求

### JSON 文件結構

```json
[
  {
    "store": "店鋪名稱",
    "machine_id": "機台ID",
    "product_name": "產品名稱",
    "quantity": 數量,
    "last_updated": "上次更新時間",
    "process_time": "2025-01-01T12:00:00+08:00"
  }
]
```

### 必要字段

- `store`: 店鋪名稱（字符串）
- `machine_id`: 機台ID（字符串）
- `product_name`: 產品名稱（字符串）
- `quantity`: 庫存數量（正整數）

### 可選字段

- `last_updated`: 上次更新時間（字符串）
- `process_time`: 處理時間（ISO 8601 格式字符串，如果沒有會自動使用當前時間）

## 錯誤處理

### 常見錯誤及解決方案

1. **文件格式錯誤**
   - 確保文件是 JSON 格式
   - 檢查 JSON 語法是否正確

2. **缺少必要字段**
   - 確保每個項目都包含 `store`、`machine_id`、`product_name`、`quantity` 字段

3. **數量字段錯誤**
   - 確保 `quantity` 是正整數

4. **日期時間格式錯誤**
   - 確保 `process_time` 是有效的 ISO 8601 格式

## 優勢

### 相比伺服器爬蟲的優勢

1. **減少伺服器負載**
   - 爬蟲在本地運行，不消耗伺服器 CPU
   - 避免伺服器超載和重啟

2. **提高穩定性**
   - 避免網站訪問高峰期影響爬蟲
   - 減少網絡連接問題

3. **更好的控制**
   - 可以選擇合適的時間運行爬蟲
   - 可以重試失敗的爬蟲任務

4. **數據驗證**
   - 上傳前可以檢查數據格式
   - 可以手動編輯數據（如果需要）

## 注意事項

1. **文件大小限制**
   - 建議單個文件不超過 10MB
   - 如果數據量很大，可以分批上傳

2. **數據覆蓋**
   - 上傳新數據會完全替換現有庫存數據
   - 請確保數據的完整性和準確性

3. **備份建議**
   - 建議保留本地生成的 JSON 文件作為備份
   - 可以記錄上傳時間和文件版本

## 故障排除

### 如果本地爬蟲失敗

1. 檢查 `.env` 文件中的帳號密碼
2. 檢查網絡連接
3. 查看 `local_scraper.log` 日誌文件
4. 嘗試重新運行腳本

### 如果上傳失敗

1. 檢查文件格式是否正確
2. 檢查網絡連接
3. 查看瀏覽器控制台錯誤信息
4. 嘗試重新上傳

## 技術細節

### API 端點

- **URL**: `/upload-inventory-file`
- **方法**: POST
- **內容類型**: multipart/form-data
- **參數**: file (JSON 文件)

### 響應格式

成功響應：
```json
{
  "success": true,
  "message": "成功上傳並處理 X 項庫存數據",
  "items_processed": 數量,
  "filename": "文件名"
}
```

錯誤響應：
```json
{
  "success": false,
  "message": "錯誤描述"
}
```

### 日誌記錄

所有上傳操作都會記錄在更新日誌中，包括：
- 上傳時間
- 處理項目數
- 文件名
- 成功/失敗狀態
- 錯誤信息（如果有） 