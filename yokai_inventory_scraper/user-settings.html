<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>使用者設定</title>
    <link rel="stylesheet" href="presentation.css" />
</head>
<body>
    <div style="max-width:720px;margin:28px auto;padding:20px;">
        <div class="user-settings-page">
            <h2 style="text-align:center;margin-bottom:12px;color:var(--primary-color);">使用者設定</h2>
            <div id="profileContainer">載入中...</div>
        </div>
    </div>
    <script>
        async function loadProfile(){
            const c = document.getElementById('profileContainer');
            c.innerHTML = '載入中...';
            try{
                const res = await fetch('/api/user-profile');
                if(!res.ok){ c.innerHTML = '<p>請先登入</p><p><a href="/presentation-login">登入</a></p>'; return; }
                const data = await res.json();
                if(!data.success){ c.innerHTML = '<p>無法載入使用者資料</p>'; return; }
                const user = data.user;
                c.innerHTML = `
                    <div class="user-settings-card">
                        <div class="user-settings-row">
                            <label class="form-label">顯示名稱</label>
                            <input id="displayName" class="form-control" value="${user.display_name || ''}" />
                        </div>
                        <div class="user-settings-row">
                            <label class="form-label">Email</label>
                            <input id="email" class="form-control" value="${user.email || ''}" />
                        </div>
                        <div class="user-settings-row">
                            <label class="form-label">低庫存通知閾值</label>
                            <select id="lowThreshold" class="form-control" style="max-width:240px;">
                                ${[5,10,15,20,25,30,35,40,45].map(n => `<option value="${n}" ${user.low_inventory_threshold==n? 'selected':''}>${n}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Change password section: show button first, inputs hidden until requested -->
                        <div class="user-settings-row" style="margin-top:12px;">
                            <label class="form-label">變更密碼</label>
                            <div style="display:flex;flex-direction:column;gap:8px;max-width:420px;">
                                <button id="showChangePwdBtn" class="btn-clear" style="max-width:180px;">變更密碼</button>

                                <div id="changePwdSection" style="display:none;padding-top:8px;">
                                    <input id="currentPassword" type="password" class="form-control" placeholder="目前密碼" />
                                    <input id="newPassword" type="password" class="form-control" placeholder="新密碼 (至少8字元)" />
                                    <input id="confirmNewPassword" type="password" class="form-control" placeholder="確認新密碼" />
                                    <div style="display:flex;gap:8px;margin-top:6px;">
                                        <button id="changePwdBtn" class="btn-primary">送出變更</button>
                                        <button id="cancelChangePwdBtn" class="btn-clear">取消</button>
                                        <div id="changePwdStatus" style="align-self:center;color:#d32f2f;margin-left:6px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-top:12px;">
                            <button id="saveBtn" class="btn-primary">儲存</button>
                            <button id="backBtn" class="btn-clear">返回</button>
                        </div>
                        <div id="saveStatus" style="color:#d32f2f;margin-top:8px;"></div>
                    </div>
                `;
                document.getElementById('backBtn').addEventListener('click', ()=>{ window.location.href='/presentation.html'; });
                document.getElementById('saveBtn').addEventListener('click', async ()=>{
                    const dn = document.getElementById('displayName').value;
                    const email = document.getElementById('email').value;
                    const low = document.getElementById('lowThreshold').value;
                    const status = document.getElementById('saveStatus');
                    status.textContent = '';
                    try{
                        const r = await fetch('/api/user-profile', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({displayName: dn, email, lowInventoryThreshold: low})});
                        const j = await r.json();
                        if(r.ok && j.success){ status.style.color='green'; status.textContent='已儲存'; setTimeout(()=>{ window.location.href='/presentation.html'; },800); }
                        else { status.style.color='#d32f2f'; status.textContent = j.message || '儲存失敗'; }
                    }catch(err){ status.style.color='#d32f2f'; status.textContent='儲存時發生錯誤'; }
                });
                // Change password: toggle UI and submission
                const showBtn = document.getElementById('showChangePwdBtn');
                const changeSection = document.getElementById('changePwdSection');
                const cancelBtn = document.getElementById('cancelChangePwdBtn');
                const submitBtn = document.getElementById('changePwdBtn');
                const statusEl = document.getElementById('changePwdStatus');

                if(showBtn && changeSection){
                    showBtn.addEventListener('click', ()=>{
                        showBtn.style.display = 'none';
                        changeSection.style.display = 'block';
                        if(statusEl) statusEl.textContent = '';
                    });
                }
                if(cancelBtn && changeSection && showBtn){
                    cancelBtn.addEventListener('click', ()=>{
                        // hide and reset
                        changeSection.style.display = 'none';
                        showBtn.style.display = 'inline-block';
                        if(statusEl) { statusEl.textContent = ''; statusEl.style.color = '#d32f2f'; }
                        // clear fields
                        const fids = ['currentPassword','newPassword','confirmNewPassword'];
                        fids.forEach(id=>{ const el = document.getElementById(id); if(el) el.value = ''; });
                    });
                }

                if(submitBtn){
                    submitBtn.addEventListener('click', async ()=>{
                        if(!statusEl) return;
                        statusEl.textContent = '';
                        const current = document.getElementById('currentPassword').value || '';
                        const nw = document.getElementById('newPassword').value || '';
                        const conf = document.getElementById('confirmNewPassword').value || '';
                        if(!current || !nw || !conf){ statusEl.style.color='#d32f2f'; statusEl.textContent='請填寫所有欄位'; return; }
                        if(nw !== conf){ statusEl.style.color='#d32f2f'; statusEl.textContent='新密碼與確認不符'; return; }
                        if(nw.length < 8){ statusEl.style.color='#d32f2f'; statusEl.textContent='新密碼長度至少 8 字元'; return; }
                        try{
                            const r = await fetch('/api/user-change-password', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({currentPassword: current, newPassword: nw})});
                            const j = await r.json();
                            if(r.ok && j.success){ statusEl.style.color='green'; statusEl.textContent='密碼已變更';
                                // clear and hide
                                ['currentPassword','newPassword','confirmNewPassword'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
                                changeSection.style.display = 'none';
                                if(showBtn) showBtn.style.display = 'inline-block';
                            } else { statusEl.style.color='#d32f2f'; statusEl.textContent = j.message || '變更失敗'; }
                        }catch(err){ statusEl.style.color='#d32f2f'; statusEl.textContent='變更時發生錯誤'; }
                    });
                }
            }catch(e){ console.error(e); c.innerHTML = '<p>載入失敗</p>'; }
        }
        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>
</body>
</html>
